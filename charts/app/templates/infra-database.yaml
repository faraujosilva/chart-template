{{- if and .Values.infrastructure.enabled .Values.infrastructure.database.enabled }}
apiVersion: app.terraform.io/v1alpha2
kind: Workspace
metadata:
  name: {{ include "app.fullname" . }}-database
  namespace: terraform-operator-system
  labels:
    {{- include "app.labels" . | nindent 4 }}
    platform.io/resource-type: database
    platform.io/app: {{ include "app.fullname" . }}
    platform.io/flavor: {{ .Values.infrastructure.database.flavor }}
    platform.io/engine: {{ .Values.infrastructure.database.engine }}
  annotations:
    platform.io/provisioned-by: helm-chart
    platform.io/drift-check: enabled
spec:
  organization: {{ .Values.infrastructure.terraform.organization }}
  name: {{ include "app.workspaceName" . }}-database
  terraformVersion: {{ .Values.infrastructure.terraform.version | quote }}
  executionMode: remote
  applyMethod: auto

  token:
    secretKeyRef:
      name: terraformcloud-credentials
      key: token

  # Module source - multi-cloud database (plataforma decide AWS/Azure)
  module:
    source: "app.terraform.io/{{ .Values.infrastructure.terraform.organization }}/database/multicloud"
    version: "1.0.0"

  terraformVariables:
    # Identificação
    - name: name
      value: {{ include "app.fullname" . | quote }}
      sensitive: false
    - name: environment
      value: {{ .Release.Namespace | quote }}
      sensitive: false

    # Engine (postgres, mysql) - dev escolhe
    - name: engine
      value: {{ .Values.infrastructure.database.engine | quote }}
      sensitive: false
    - name: engine_version
      value: {{ .Values.infrastructure.database.version | quote }}
      sensitive: false

    # Flavor abstrato (small, medium, large, xlarge)
    # O módulo Terraform traduz para instance type apropriado
    - name: flavor
      value: {{ .Values.infrastructure.database.flavor | quote }}
      sensitive: false
    - name: storage_size
      value: {{ .Values.infrastructure.database.storageSize | quote }}
      sensitive: false

    # Opções
    - name: high_availability
      value: {{ .Values.infrastructure.database.highAvailability | quote }}
      sensitive: false
    - name: backup_retention_days
      value: {{ .Values.infrastructure.database.backupRetentionDays | quote }}
      sensitive: false

    # Metadata
    - name: owner
      value: {{ .Values.app.team | quote }}
      sensitive: false
    - name: cost_center
      value: {{ .Values.app.costCenter | default "default" | quote }}
      sensitive: false

  tags:
    - platform-mvp
    - database
    - {{ .Values.infrastructure.database.engine }}
    - {{ .Values.infrastructure.database.flavor }}
    - {{ .Release.Namespace }}
{{- end }}

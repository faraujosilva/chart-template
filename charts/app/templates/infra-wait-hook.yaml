{{- if and .Values.infrastructure.enabled .Values.infrastructure.storage.enabled }}
################################################################################
# Sync Hook: Aguarda infraestrutura estar pronta antes de criar aplica√ß√£o
#
# OBJETIVO: Garantir que o HCP Terraform Operator tenha finalizado o 
# provisionamento antes de criar o Deployment (que depende dos outputs)
#
# ORDEM DE EXECU√á√ÉO:
#   Wave 0: Workspace (define vari√°veis Terraform)
#   Wave 1: Module (executa Terraform) + ConfigMap da app
#   Wave 1.5: Este Job (aguarda Module status = Applied)
#   Wave 2: Deployment + Service (usa outputs do Terraform)
#   Wave 3: Ingress + HPA
################################################################################
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "app.fullname" . }}-wait-infra
  namespace: terraform-operator-system
  labels:
    {{- include "app.labels" . | nindent 4 }}
    platform.io/component: infra-wait
  annotations:
    # Sync Wave entre Module (1) e Deployment (2)
    argocd.argoproj.io/sync-wave: "1"
    # Hook que roda durante o sync e √© deletado ap√≥s sucesso
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 30
  template:
    metadata:
      labels:
        {{- include "app.selectorLabels" . | nindent 8 }}
        platform.io/component: infra-wait
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ include "app.fullname" . }}-infra-checker
      containers:
        - name: wait-for-infra
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e
              MODULE_NAME="{{ include "app.fullname" . }}-storage"
              NAMESPACE="terraform-operator-system"
              MAX_ATTEMPTS=60
              SLEEP_SECONDS=10
              
              echo "=========================================="
              echo "üîÑ Aguardando infraestrutura: $MODULE_NAME"
              echo "=========================================="
              
              for i in $(seq 1 $MAX_ATTEMPTS); do
                echo ""
                echo "üì° Tentativa $i/$MAX_ATTEMPTS - Verificando Module status..."
                
                # Obt√©m o status do Module
                STATUS=$(kubectl get module $MODULE_NAME -n $NAMESPACE -o jsonpath='{.status.runStatus}' 2>/dev/null || echo "NotFound")
                
                echo "   Status atual: $STATUS"
                
                case $STATUS in
                  "applied")
                    echo ""
                    echo "‚úÖ SUCCESS: Infraestrutura provisionada com sucesso!"
                    echo ""
                    
                    # Mostra outputs se dispon√≠veis
                    echo "üì¶ Outputs do Terraform:"
                    kubectl get module $MODULE_NAME -n $NAMESPACE -o jsonpath='{.status.outputs}' 2>/dev/null | jq . || echo "   (outputs n√£o dispon√≠veis)"
                    
                    exit 0
                    ;;
                  "errored"|"discarded"|"canceled")
                    echo ""
                    echo "‚ùå ERRO: Provisionamento falhou com status: $STATUS"
                    echo ""
                    echo "üîç Detalhes do erro:"
                    kubectl get module $MODULE_NAME -n $NAMESPACE -o yaml | grep -A 20 "status:" || true
                    exit 1
                    ;;
                  "pending"|"planning"|"planned"|"applying"|"plan_queued"|"apply_queued")
                    echo "   ‚è≥ Terraform em execu√ß√£o... aguardando ${SLEEP_SECONDS}s"
                    ;;
                  "NotFound")
                    echo "   ‚ö†Ô∏è  Module ainda n√£o criado... aguardando ${SLEEP_SECONDS}s"
                    ;;
                  *)
                    echo "   üîÑ Status desconhecido: $STATUS... aguardando ${SLEEP_SECONDS}s"
                    ;;
                esac
                
                sleep $SLEEP_SECONDS
              done
              
              echo ""
              echo "‚ùå TIMEOUT: Infraestrutura n√£o ficou pronta em $(($MAX_ATTEMPTS * $SLEEP_SECONDS))s"
              exit 1
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "app.fullname" . }}-infra-checker
  namespace: terraform-operator-system
  labels:
    {{- include "app.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "app.fullname" . }}-module-reader
  namespace: terraform-operator-system
  labels:
    {{- include "app.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
rules:
  - apiGroups: ["app.terraform.io"]
    resources: ["modules", "workspaces"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "app.fullname" . }}-module-reader
  namespace: terraform-operator-system
  labels:
    {{- include "app.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
subjects:
  - kind: ServiceAccount
    name: {{ include "app.fullname" . }}-infra-checker
    namespace: terraform-operator-system
roleRef:
  kind: Role
  name: {{ include "app.fullname" . }}-module-reader
  apiGroup: rbac.authorization.k8s.io
{{- end }}

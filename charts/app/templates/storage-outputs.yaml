{{- if and .Values.infrastructure.enabled .Values.infrastructure.storage.enabled }}
---
################################################################################
# Storage Outputs Secret Sync
#
# O HCP Terraform Operator cria automaticamente um Secret com os outputs
# do módulo Terraform. Este template referencia esse secret e o torna
# disponível para a aplicação.
#
# O Operator cria: <module-name>-outputs
#
# Features:
#   - Auto-sync de outputs do Terraform
#   - Secrets injetados como env vars na aplicação
#   - Suporta AWS (S3) e Azure (Storage Account)
################################################################################

{{/*
O HCP Terraform Operator cria automaticamente um secret com nome:
  <module-name>-outputs

Exemplo de outputs no secret (AWS S3):
  STORAGE_BUCKET_NAME: my-app-bucket-dev-abc123
  STORAGE_BUCKET_ARN: arn:aws:s3:::my-app-bucket-dev-abc123
  STORAGE_BUCKET_REGION: us-east-1
  STORAGE_BUCKET_DOMAIN: my-app-bucket-dev-abc123.s3.amazonaws.com

Exemplo de outputs no secret (Azure Storage):
  STORAGE_ACCOUNT_NAME: myappdevxyz123
  STORAGE_ACCOUNT_ID: /subscriptions/.../storageAccounts/myappdevxyz123
  STORAGE_BLOB_ENDPOINT: https://myappdevxyz123.blob.core.windows.net/
  STORAGE_ACCESS_KEY: <key-value>
*/}}

# Nota: O Secret é criado automaticamente pelo HCP Terraform Operator
# Referência: {{ include "app.fullname" . }}-storage-outputs
#
# Este ConfigMap documenta os outputs disponíveis
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "app.fullname" . }}-storage-outputs-info
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
    platform.io/resource-type: storage-outputs-info
  annotations:
    platform.io/description: "Documentation of storage outputs available from HCP Terraform"
data:
  README.md: |
    # Storage Outputs
    
    Este storage foi provisionado pelo HCP Terraform Operator usando um módulo {{ include "app.cloudProvider" . | upper }}.
    
    ## Informações do Provisioning
    
    - **Cloud Provider:** {{ include "app.cloudProvider" . | upper }}
    - **Flavor:** {{ .Values.infrastructure.storage.flavor }}
    - **Encryption:** {{ .Values.infrastructure.storage.encryption }}
    - **Versioning:** {{ .Values.infrastructure.storage.versioning }}
    - **Estimated Monthly Cost:** ${{ include "app.estimatedCost" . }} USD
    
    ## Outputs Disponíveis
    
    Os outputs do Terraform estão disponíveis no secret:
    
    ```
    kubectl get secret {{ include "app.fullname" . }}-storage-outputs -n {{ .Values.infrastructure.terraform.namespace | default "terraform-system" }}
    ```
    
    {{- if eq (include "app.cloudProvider" .) "aws" }}
    
    ### AWS S3 Outputs
    
    - `STORAGE_BUCKET_NAME`: Nome do bucket S3
    - `STORAGE_BUCKET_ARN`: ARN do bucket
    - `STORAGE_BUCKET_REGION`: Região AWS
    - `STORAGE_BUCKET_DOMAIN`: Domain name do bucket
    
    ### Exemplo de uso (Python boto3)
    
    ```python
    import os
    import boto3
    
    s3_client = boto3.client('s3', region_name=os.getenv('STORAGE_BUCKET_REGION'))
    bucket_name = os.getenv('STORAGE_BUCKET_NAME')
    
    # Upload file
    s3_client.upload_file('local_file.txt', bucket_name, 'remote_file.txt')
    ```
    
    {{- else if eq (include "app.cloudProvider" .) "azure" }}
    
    ### Azure Storage Account Outputs
    
    - `STORAGE_ACCOUNT_NAME`: Nome da storage account
    - `STORAGE_ACCOUNT_ID`: Resource ID da storage account
    - `STORAGE_BLOB_ENDPOINT`: Endpoint do blob storage
    - `STORAGE_ACCESS_KEY`: Access key (sensível)
    
    ### Exemplo de uso (Python azure-storage-blob)
    
    ```python
    import os
    from azure.storage.blob import BlobServiceClient
    
    connection_string = f"DefaultEndpointsProtocol=https;AccountName={os.getenv('STORAGE_ACCOUNT_NAME')};AccountKey={os.getenv('STORAGE_ACCESS_KEY')};EndpointSuffix=core.windows.net"
    
    blob_service_client = BlobServiceClient.from_connection_string(connection_string)
    
    # Upload file
    container_client = blob_service_client.get_container_client("mycontainer")
    blob_client = container_client.get_blob_client("myblob.txt")
    
    with open("local_file.txt", "rb") as data:
        blob_client.upload_blob(data)
    ```
    
    {{- end }}
    
    ## HCP Terraform Workspace
    
    View workspace: https://app.terraform.io/app/{{ .Values.infrastructure.terraform.organization }}/workspaces/{{ include "app.fullname" . }}-storage-{{ .Release.Namespace }}
    
    ## Drift Detection
    
    {{- if .Values.infrastructure.driftDetection.enabled }}
    Drift detection está **HABILITADO** e roda a cada {{ .Values.infrastructure.driftDetection.schedule }}.
    
    Verifique o status:
    ```
    kubectl get module {{ include "app.fullname" . }}-storage -n {{ .Values.infrastructure.terraform.namespace | default "terraform-system" }} -o jsonpath='{.metadata.annotations.platform\.io/drift-status}'
    ```
    {{- else }}
    Drift detection está **DESABILITADO**.
    {{- end }}

  cloud-provider: {{ include "app.cloudProvider" . | quote }}
  flavor: {{ .Values.infrastructure.storage.flavor | quote }}
  terraform-workspace: {{ include "app.fullname" . }}-storage-{{ .Release.Namespace }}
  
  {{- if eq (include "app.cloudProvider" .) "aws" }}
  # AWS specific metadata
  aws-region: {{ .Values.infrastructure.aws.region | default "us-east-1" | quote }}
  bucket-naming-pattern: {{ include "app.storageBucketName" . | quote }}
  {{- else if eq (include "app.cloudProvider" .) "azure" }}
  # Azure specific metadata
  azure-location: {{ .Values.infrastructure.azure.location | default "eastus" | quote }}
  storage-account-pattern: {{ include "app.storageAccountName" . | quote }}
  account-tier: {{ include "app.azureAccountTier" . | quote }}
  replication-type: {{ include "app.azureReplicationType" . | quote }}
  {{- end }}

{{- end }}

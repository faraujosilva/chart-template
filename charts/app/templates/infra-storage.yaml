{{- if and .Values.infrastructure.enabled .Values.infrastructure.storage.enabled }}
################################################################################
# HCP Terraform Operator - S3 Storage Provisioning
#
# ABSTRAÇÃO: Dev escolhe apenas FLAVOR
#   - standard: S3 Standard (acesso frequente)
#   - economy:  S3 Standard-IA (acesso infrequente)  
#   - archive:  S3 Glacier (cold storage)
#
# Recursos criados:
#   1. Workspace - Define variáveis e configurações
#   2. Module - Referencia o módulo Terraform e usa as variáveis do Workspace
################################################################################
---
apiVersion: app.terraform.io/v1alpha2
kind: Workspace
metadata:
  name: {{ include "app.fullname" . }}-storage
  namespace: terraform-operator-system
  labels:
    {{- include "app.labels" . | nindent 4 }}
    platform.io/resource-type: storage
    platform.io/flavor: {{ .Values.infrastructure.storage.flavor }}
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  organization: {{ .Values.infrastructure.organization }}
  name: {{ include "app.fullname" . }}-storage
  terraformVersion: {{ .Values.infrastructure.terraformVersion | default "1.14.1" | quote }}
  applyMethod: auto
  allowDestroyPlan: true
  
  token:
    secretKeyRef:
      name: terraformcloud-credentials
      key: token
  
  # Variáveis Terraform definidas aqui
  terraformVariables:
    - name: bucket
      value: "{{ include "app.fullname" . }}-{{ .Values.infrastructure.storage.flavor }}-bucket"
    
    - name: force_destroy
      value: "true"
    
    - name: versioning
      hcl: true
      value: |
        {
          enabled = {{ .Values.infrastructure.storage.versioning | default false }}
        }
    
    {{- if .Values.infrastructure.storage.encryption | default true }}
    - name: server_side_encryption_configuration
      hcl: true
      value: |
        {
          rule = {
            apply_server_side_encryption_by_default = {
              sse_algorithm = "AES256"
            }
          }
        }
    {{- end }}
    
    {{- if eq .Values.infrastructure.storage.flavor "economy" }}
    - name: lifecycle_rule
      hcl: true
      value: |
        [
          {
            id      = "transition-to-ia"
            enabled = true
            transition = [
              {
                days          = 30
                storage_class = "STANDARD_IA"
              }
            ]
          }
        ]
    {{- else if eq .Values.infrastructure.storage.flavor "archive" }}
    - name: lifecycle_rule
      hcl: true
      value: |
        [
          {
            id      = "transition-to-glacier"
            enabled = true
            transition = [
              {
                days          = 7
                storage_class = "GLACIER"
              }
            ]
          }
        ]
    {{- end }}
    
    - name: tags
      hcl: true
      value: |
        {
          Name      = "{{ include "app.fullname" . }}"
          Team      = "{{ .Values.app.team | default "platform" }}"
          Flavor    = "{{ .Values.infrastructure.storage.flavor }}"
          ManagedBy = "hcp-terraform-operator"
        }
  
  tags:
    - platform-managed
    - storage
    - {{ .Values.infrastructure.storage.flavor }}
---
apiVersion: app.terraform.io/v1alpha2
kind: Module
metadata:
  name: {{ include "app.fullname" . }}-storage
  namespace: terraform-operator-system
  labels:
    {{- include "app.labels" . | nindent 4 }}
    platform.io/resource-type: storage
    platform.io/flavor: {{ .Values.infrastructure.storage.flavor }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  organization: {{ .Values.infrastructure.organization }}
  
  token:
    secretKeyRef:
      name: terraformcloud-credentials
      key: token
  
  module:
    source: "terraform-aws-modules/s3-bucket/aws"
    version: "5.10.0"
  
  deletionPolicy : destroy
  
  # Referencia as variáveis definidas no Workspace
  variables:
    - name: bucket
    - name: force_destroy
    - name: versioning
    {{- if .Values.infrastructure.storage.encryption | default true }}
    - name: server_side_encryption_configuration
    {{- end }}
    {{- if or (eq .Values.infrastructure.storage.flavor "economy") (eq .Values.infrastructure.storage.flavor "archive") }}
    - name: lifecycle_rule
    {{- end }}
    - name: tags
  
  # Outputs mapeados para ConfigMap/Secret
  outputs:
    - name: s3_bucket_id
    - name: s3_bucket_arn
    - name: s3_bucket_bucket_domain_name
    - name: s3_bucket_region
  
  # Referencia o Workspace criado acima
  workspace:
    name: {{ include "app.fullname" . }}-storage
{{- end }}

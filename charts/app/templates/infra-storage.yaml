{{- if and .Values.infrastructure.enabled .Values.infrastructure.storage.enabled }}
################################################################################
# HCP Terraform Operator - S3 Storage Provisioning
#
# ABSTRAÇÃO: Dev escolhe apenas FLAVOR
#   - standard: S3 Standard (acesso frequente)
#   - economy:  S3 Standard-IA (acesso infrequente)
#   - archive:  S3 Glacier (cold storage)
#
# Outputs criados automaticamente pelo Operator:
#   - ConfigMap: <name>-outputs (bucket_name, bucket_arn, etc)
################################################################################
---
apiVersion: app.terraform.io/v1alpha2
kind: Workspace
metadata:
  name: {{ include "app.fullname" . }}-storage
  namespace: terraform-operator-system
  labels:
    {{- include "app.labels" . | nindent 4 }}
    platform.io/resource-type: storage
    platform.io/app: {{ include "app.fullname" . }}
    platform.io/flavor: {{ .Values.infrastructure.storage.flavor }}
  annotations:
    platform.io/provisioned-by: helm-chart
    platform.io/drift-check: enabled
    workspace.app.terraform.io/run-type: apply
spec:
  organization: plathub
  name: {{ include "app.workspaceName" . }}-storage
  terraformVersion: 1.14.1
  applyMethod: auto
  deletionPolicy: destroy
  token:
    secretKeyRef:
      name: terraformcloud-credentials
      key: token
  terraformVariables:
    - name: app_name
      value: {{ include "app.fullname" . }}

    - name: flavor
      value: {{ .Values.infrastructure.storage.flavor }}

---
apiVersion: app.terraform.io/v1alpha2
kind: Module
metadata:
  name: {{ include "app.fullname" . }}-storage
  namespace: terraform-operator-system
  labels:
    {{- include "app.labels" . | nindent 4 }}
    platform.io/resource-type: storage
    platform.io/flavor: {{ .Values.infrastructure.storage.flavor }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  organization: plathub
  
  token:
    secretKeyRef:
      name: {{ .Values.infrastructure.tokenSecret | default "hcp-terraform-token" }}
      key: token

  module:
    source: "terraform-aws-modules/s3-bucket/aws"
    version: "~> 4.0"
  
  destroyOnDeletion: true
  
  variables:
    # Bucket name
    - name: bucket
      value: "{{ include "app.fullname" . }}-{{ .Values.infrastructure.storage.flavor }}-bucket"
    
    - name: force_destroy
      value: "true"
    
    # Versioning
    - name: versioning
      hcl: true
      value: |
        {
          enabled = {{ .Values.infrastructure.storage.versioning | default false }}
        }
    
    {{- if .Values.infrastructure.storage.encryption | default true }}
    # Encryption
    - name: server_side_encryption_configuration
      hcl: true
      value: |
        {
          rule = {
            apply_server_side_encryption_by_default = {
              sse_algorithm = "AES256"
            }
          }
        }
    {{- end }}
    
    {{- if eq .Values.infrastructure.storage.flavor "economy" }}
    # Economy: Transition to Standard-IA after 30 days
    - name: lifecycle_rule
      hcl: true
      value: |
        [
          {
            id      = "transition-to-ia"
            enabled = true
            transition = [
              {
                days          = 30
                storage_class = "STANDARD_IA"
              }
            ]
          }
        ]
    {{- else if eq .Values.infrastructure.storage.flavor "archive" }}
    # Archive: Transition to Glacier after 7 days
    - name: lifecycle_rule
      hcl: true
      value: |
        [
          {
            id      = "transition-to-glacier"
            enabled = true
            transition = [
              {
                days          = 7
                storage_class = "GLACIER"
              }
            ]
          }
        ]
    {{- end }}
    
    # Tags
    - name: tags
      hcl: true
      value: |
        {
          Name      = "{{ include "app.fullname" . }}"
          Team      = "{{ .Values.app.team | default "platform" }}"
          Flavor    = "{{ .Values.infrastructure.storage.flavor }}"
          ManagedBy = "hcp-terraform-operator"
        }

  # Outputs - serão criados como ConfigMap/Secret automaticamente
  outputs:
    - name: s3_bucket_id
      key: STORAGE_NAME
    - name: s3_bucket_arn
      key: STORAGE_ARN
    - name: s3_bucket_bucket_domain_name
      key: STORAGE_ENDPOINT
    - name: s3_bucket_region
      key: STORAGE_REGION

  # Workspace configuration
  workspace:
    name: {{ include "app.fullname" . }}-storage
    terraformVersion: {{ .Values.infrastructure.terraformVersion | default "1.14.1" }}
{{- end }}

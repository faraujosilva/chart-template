{{- if and .Values.infrastructure.enabled .Values.infrastructure.cache.enabled }}
apiVersion: app.terraform.io/v1alpha2
kind: Workspace
metadata:
  name: {{ include "app.fullname" . }}-cache
  namespace: terraform-operator-system
  labels:
    {{- include "app.labels" . | nindent 4 }}
    platform.io/resource-type: cache
    platform.io/app: {{ include "app.fullname" . }}
    platform.io/flavor: {{ .Values.infrastructure.cache.flavor }}
    platform.io/engine: {{ .Values.infrastructure.cache.engine }}
  annotations:
    platform.io/provisioned-by: helm-chart
    platform.io/drift-check: enabled
spec:
  organization: {{ .Values.infrastructure.terraform.organization }}
  name: {{ include "app.workspaceName" . }}-cache
  terraformVersion: {{ .Values.infrastructure.terraform.version | quote }}
  executionMode: remote
  applyMethod: auto

  token:
    secretKeyRef:
      name: terraformcloud-credentials
      key: token

  # Module source - multi-cloud cache (plataforma decide AWS/Azure)
  module:
    source: "app.terraform.io/{{ .Values.infrastructure.terraform.organization }}/cache/multicloud"
    version: "1.0.0"

  terraformVariables:
    # Identificação
    - name: name
      value: {{ include "app.fullname" . | quote }}
      sensitive: false
    - name: environment
      value: {{ .Release.Namespace | quote }}
      sensitive: false

    # Engine (redis, memcached) - dev escolhe
    - name: engine
      value: {{ .Values.infrastructure.cache.engine | quote }}
      sensitive: false

    # Flavor abstrato (small, medium, large)
    # O módulo Terraform traduz para node type apropriado
    - name: flavor
      value: {{ .Values.infrastructure.cache.flavor | quote }}
      sensitive: false

    # Opções
    - name: high_availability
      value: {{ .Values.infrastructure.cache.highAvailability | quote }}
      sensitive: false

    # Metadata
    - name: owner
      value: {{ .Values.app.team | quote }}
      sensitive: false
    - name: cost_center
      value: {{ .Values.app.costCenter | default "default" | quote }}
      sensitive: false

  tags:
    - platform-mvp
    - cache
    - {{ .Values.infrastructure.cache.engine }}
    - {{ .Values.infrastructure.cache.flavor }}
    - {{ .Release.Namespace }}
{{- end }}
